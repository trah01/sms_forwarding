# çŸ­ä¿¡è½¬å‘å™¨ MQTT ä¼ æ„Ÿå™¨é…ç½®
# 
# ä½¿ç”¨æ–¹æ³•ï¼š
# 1. å°†æ­¤å†…å®¹æ·»åŠ åˆ° configuration.yaml
# 2. æŠŠ "123456" æ›¿æ¢æˆä½ çš„è®¾å¤‡ IDï¼ˆåœ¨çŸ­ä¿¡è½¬å‘å™¨ç½‘é¡µæŸ¥çœ‹ï¼‰
# 3. æŠŠ "sms" æ›¿æ¢æˆä½ è®¾ç½®çš„ä¸»é¢˜å‰ç¼€ï¼ˆå¦‚æœæœ‰ä¿®æ”¹çš„è¯ï¼‰
# 4. é‡å¯ Home Assistant

mqtt:
  sensor:
    # è®¾å¤‡åœ¨çº¿çŠ¶æ€
    - name: "çŸ­ä¿¡è½¬å‘å™¨çŠ¶æ€"
      unique_id: sms_forwarder_status
      state_topic: "sms/123456/status"
      value_template: "{{ value_json.status }}"
      icon: mdi:message-text
      
    # WiFi ä¿¡å·å¼ºåº¦
    - name: "çŸ­ä¿¡è½¬å‘å™¨ WiFi ä¿¡å·"
      unique_id: sms_forwarder_wifi
      state_topic: "sms/123456/status"
      value_template: >-
        {% set rssi = value_json.wifi_rssi | int(-999) %}
        {% set status = value_json.wifi_status | default('æœªçŸ¥') %}
        {% if rssi == -999 %}æœªçŸ¥
        {% else %}{{ rssi }} dBm ({{ status }})
        {% endif %}
      icon: mdi:wifi
      
    # 4G ä¿¡å·å¼ºåº¦
    - name: "çŸ­ä¿¡è½¬å‘å™¨ 4G ä¿¡å·"
      unique_id: sms_forwarder_lte
      state_topic: "sms/123456/status"
      value_template: >-
        {% set rsrp = value_json.lte_rsrp | int(-999) %}
        {% set status = value_json.lte_status | default('æœªçŸ¥') %}
        {% if rsrp == -999 %}æœªçŸ¥
        {% else %}{{ rsrp }} dBm ({{ status }})
        {% endif %}
      icon: mdi:signal-4g
      
    # APN
    - name: "çŸ­ä¿¡è½¬å‘å™¨ APN"
      unique_id: sms_forwarder_apn
      state_topic: "sms/123456/status"
      value_template: "{{ value_json.apn | default('æœªçŸ¥') }}"
      icon: mdi:access-point-network
      
    # è®¾å¤‡ IP åœ°å€
    - name: "çŸ­ä¿¡è½¬å‘å™¨ IP"
      unique_id: sms_forwarder_ip
      state_topic: "sms/123456/status"
      value_template: "{{ value_json.ip }}"
      icon: mdi:ip-network
      
    # è¿è¡Œæ—¶é—´
    - name: "çŸ­ä¿¡è½¬å‘å™¨è¿è¡Œæ—¶é—´"
      unique_id: sms_forwarder_uptime
      state_topic: "sms/123456/status"
      value_template: "{{ (value_json.uptime | int / 3600) | round(1) }}"
      unit_of_measurement: "å°æ—¶"
      icon: mdi:clock-outline
      
    # æœ€è¿‘æ”¶åˆ°çš„çŸ­ä¿¡ - å‘é€è€…
    - name: "æœ€è¿‘çŸ­ä¿¡å‘é€è€…"
      unique_id: sms_forwarder_last_sender
      state_topic: "sms/123456/sms/received"
      value_template: "{{ value_json.sender }}"
      icon: mdi:account
      
    # æœ€è¿‘æ”¶åˆ°çš„çŸ­ä¿¡ - å†…å®¹
    # æ³¨æ„: çŠ¶æ€å€¼æœ‰ 255 å­—ç¬¦é™åˆ¶ï¼Œå®Œæ•´å†…å®¹å­˜å‚¨åœ¨ message å±æ€§ä¸­
    - name: "æœ€è¿‘çŸ­ä¿¡å†…å®¹"
      unique_id: sms_forwarder_last_message
      state_topic: "sms/123456/sms/received"
      value_template: >-
        {% set msg = value_json.message | default('') %}
        {% if msg | length > 50 %}
          {{ msg[:50] }}...
        {% else %}
          {{ msg }}
        {% endif %}
      # å®Œæ•´çŸ­ä¿¡å†…å®¹å­˜å‚¨åœ¨å±æ€§ä¸­ï¼Œæ”¯æŒæ¢è¡Œæ˜¾ç¤º
      json_attributes_topic: "sms/123456/sms/received"
      json_attributes_template: >-
        {
          "message": {{ value_json.message | default('') | tojson }},
          "sender": {{ value_json.sender | default('') | tojson }},
          "time": {{ value_json.time | default('') | tojson }}
        }
      icon: mdi:message-text
      
    # æœ€è¿‘æ¥ç”µå·ç 
    - name: "æœ€è¿‘æ¥ç”µå·ç "
      unique_id: sms_forwarder_last_caller
      state_topic: "sms/123456/call"
      value_template: "{{ value_json.caller }}"
      icon: mdi:phone-incoming

  # äºŒè¿›åˆ¶ä¼ æ„Ÿå™¨ - åœ¨çº¿çŠ¶æ€
  binary_sensor:
    - name: "çŸ­ä¿¡è½¬å‘å™¨åœ¨çº¿"
      unique_id: sms_forwarder_online
      state_topic: "sms/123456/status"
      value_template: "{{ value_json.status }}"
      payload_on: "online"
      payload_off: "offline"
      device_class: connectivity
      icon: mdi:message-check

  # æŒ‰é’® - æ§åˆ¶å‘½ä»¤
  button:
    # é‡å¯è®¾å¤‡
    - name: "çŸ­ä¿¡è½¬å‘å™¨é‡å¯"
      unique_id: sms_forwarder_restart
      command_topic: "sms/123456/cmd"
      payload_press: '{"action":"restart"}'
      icon: mdi:restart
      
    # Ping æµ‹è¯•
    - name: "çŸ­ä¿¡è½¬å‘å™¨ Ping"
      unique_id: sms_forwarder_ping
      command_topic: "sms/123456/ping"
      payload_press: '{}'
      icon: mdi:access-point

# ===========================================
# ä»¥ä¸‹é…ç½®éœ€è¦æ”¾åœ¨ configuration.yaml æ ¹çº§åˆ«
# ===========================================

# è¾“å…¥è¾…åŠ©å®ä½“ - å‘é€çŸ­ä¿¡
input_text:
  sms_phone:
    name: "ç›®æ ‡æ‰‹æœºå·"
    initial: ""
    max: 20
    icon: mdi:phone
    
  sms_message:
    name: "çŸ­ä¿¡å†…å®¹"
    initial: ""
    max: 500
    icon: mdi:message-text

# ç¡®è®¤å¼€å…³ - ç”¨äºäºŒæ¬¡ç¡®è®¤
input_boolean:
  sms_confirm:
    name: "ç¡®è®¤å‘é€çŸ­ä¿¡"
    initial: false
    icon: mdi:check-circle-outline
    
  ping_confirm:
    name: "ç¡®è®¤æ‰§è¡Œ Ping"
    initial: false
    icon: mdi:check-circle-outline
    
  restart_confirm:
    name: "ç¡®è®¤é‡å¯è®¾å¤‡"
    initial: false
    icon: mdi:check-circle-outline

# ===========================================
# è„šæœ¬ - å¸¦äºŒæ¬¡ç¡®è®¤çš„æ“ä½œ
# ===========================================

script:
  # å‘é€çŸ­ä¿¡ - éœ€è¦å…ˆæ‰“å¼€ç¡®è®¤å¼€å…³
  send_sms:
    alias: "å‘é€çŸ­ä¿¡"
    icon: mdi:message-arrow-right
    sequence:
      - choose:
          # æ£€æŸ¥ç¡®è®¤å¼€å…³æ˜¯å¦å·²æ‰“å¼€
          - conditions:
              - condition: state
                entity_id: input_boolean.sms_confirm
                state: "on"
              # æ£€æŸ¥æ‰‹æœºå·ä¸ä¸ºç©º
              - condition: template
                value_template: "{{ states('input_text.sms_phone') | length > 0 }}"
              # æ£€æŸ¥çŸ­ä¿¡å†…å®¹ä¸ä¸ºç©º
              - condition: template
                value_template: "{{ states('input_text.sms_message') | length > 0 }}"
            sequence:
              - service: mqtt.publish
                data:
                  topic: "sms/123456/sms/send"
                  payload: >-
                    {"phone":"{{ states('input_text.sms_phone') }}","message":"{{ states('input_text.sms_message') }}"}
              - service: persistent_notification.create
                data:
                  title: "âœ… çŸ­ä¿¡å·²å‘é€"
                  message: "å‘é€åˆ°ï¼š{{ states('input_text.sms_phone') }}"
              # é‡ç½®ç¡®è®¤å¼€å…³
              - service: input_boolean.turn_off
                target:
                  entity_id: input_boolean.sms_confirm
        default:
          # æœªç¡®è®¤æ—¶æ˜¾ç¤ºæé†’
          - service: persistent_notification.create
            data:
              title: "âš ï¸ è¯·å…ˆç¡®è®¤"
              message: |
                å‘é€çŸ­ä¿¡éœ€è¦äºŒæ¬¡ç¡®è®¤ï¼š
                1. è¯·ç¡®è®¤æ‰‹æœºå·å’ŒçŸ­ä¿¡å†…å®¹å·²å¡«å†™
                2. æ‰“å¼€ã€Œç¡®è®¤å‘é€çŸ­ä¿¡ã€å¼€å…³
                3. å†æ¬¡ç‚¹å‡»ã€Œå‘é€çŸ­ä¿¡ã€æŒ‰é’®
          
  # æ‰§è¡Œ Ping æµ‹è¯• - éœ€è¦å…ˆæ‰“å¼€ç¡®è®¤å¼€å…³
  ping_sms_forwarder:
    alias: "æ‰§è¡ŒPingæµ‹è¯•"
    icon: mdi:access-point
    sequence:
      - choose:
          - conditions:
              - condition: state
                entity_id: input_boolean.ping_confirm
                state: "on"
            sequence:
              - service: mqtt.publish
                data:
                  topic: "sms/123456/ping"
                  payload: '{}'
              - service: persistent_notification.create
                data:
                  title: "âœ… Pingå‘½ä»¤å·²å‘é€"
                  message: "æ­£åœ¨æ‰§è¡Œç½‘ç»œPingæµ‹è¯•"
              # é‡ç½®ç¡®è®¤å¼€å…³
              - service: input_boolean.turn_off
                target:
                  entity_id: input_boolean.ping_confirm
        default:
          - service: persistent_notification.create
            data:
              title: "âš ï¸ è¯·å…ˆç¡®è®¤"
              message: "è¯·å…ˆæ‰“å¼€ã€Œç¡®è®¤æ‰§è¡Œ Pingã€å¼€å…³ï¼Œå†ç‚¹å‡»æ‰§è¡Œ"
                
  # é‡å¯è®¾å¤‡ - éœ€è¦å…ˆæ‰“å¼€ç¡®è®¤å¼€å…³
  restart_sms_forwarder:
    alias: "é‡å¯çŸ­ä¿¡è½¬å‘å™¨"
    icon: mdi:restart
    sequence:
      - choose:
          - conditions:
              - condition: state
                entity_id: input_boolean.restart_confirm
                state: "on"
            sequence:
              - service: mqtt.publish
                data:
                  topic: "sms/123456/cmd"
                  payload: '{"action":"restart"}'
              - service: persistent_notification.create
                data:
                  title: "âœ… é‡å¯å‘½ä»¤å·²å‘é€"
                  message: "çŸ­ä¿¡è½¬å‘å™¨å°†åœ¨å‡ ç§’åé‡å¯"
              # é‡ç½®ç¡®è®¤å¼€å…³
              - service: input_boolean.turn_off
                target:
                  entity_id: input_boolean.restart_confirm
        default:
          - service: persistent_notification.create
            data:
              title: "âš ï¸ è¯·å…ˆç¡®è®¤"
              message: "è¯·å…ˆæ‰“å¼€ã€Œç¡®è®¤é‡å¯è®¾å¤‡ã€å¼€å…³ï¼Œå†ç‚¹å‡»é‡å¯"

# ===========================================
# Lovelace ä»ªè¡¨æ¿å¡ç‰‡é…ç½®ç¤ºä¾‹
# å°†ä»¥ä¸‹å†…å®¹å¤åˆ¶åˆ° Lovelace çš„"ç¼–è¾‘ä»ªè¡¨æ¿" -> "åŸå§‹é…ç½®ç¼–è¾‘å™¨"ä¸­
# ===========================================

# çŸ­ä¿¡å†…å®¹æ˜¾ç¤ºå¡ç‰‡ (æ”¯æŒæ¢è¡Œ)
# ä½¿ç”¨ Markdown å¡ç‰‡å¯ä»¥æ­£ç¡®æ˜¾ç¤ºå¤šè¡ŒçŸ­ä¿¡å†…å®¹
# 
# type: markdown
# title: ğŸ“± æœ€è¿‘çŸ­ä¿¡
# content: |
#   **å‘é€è€…:** {{ state_attr('sensor.zui_jin_duan_xin_nei_rong', 'sender') }}
#   
#   **æ—¶é—´:** {{ state_attr('sensor.zui_jin_duan_xin_nei_rong', 'time') }}
#   
#   ---
#   
#   {{ state_attr('sensor.zui_jin_duan_xin_nei_rong', 'message') }}

# å¦ä¸€ç§æ–¹å¼ï¼šä½¿ç”¨æ¨¡æ¿ä¼ æ„Ÿå™¨ (æ”¾åœ¨ configuration.yaml ä¸­)
# è¿™ç§æ–¹å¼å¯ä»¥åˆ›å»ºä¸€ä¸ªä¸“é—¨ç”¨äºæ˜¾ç¤ºçš„å®ä½“
template:
  - sensor:
      - name: "çŸ­ä¿¡è¯¦æƒ…"
        unique_id: sms_forwarder_full_message
        state: >-
          {{ states('sensor.zui_jin_duan_xin_fa_song_zhe') }}
        attributes:
          sender: >-
            {{ state_attr('sensor.zui_jin_duan_xin_nei_rong', 'sender') }}
          time: >-
            {{ state_attr('sensor.zui_jin_duan_xin_nei_rong', 'time') }}
          message: >-
            {{ state_attr('sensor.zui_jin_duan_xin_nei_rong', 'message') }}
          # æ ¼å¼åŒ–æ˜¾ç¤ºï¼Œç”¨äº Markdown å¡ç‰‡
          formatted: >-
            ğŸ“ **å‘é€è€…:** {{ state_attr('sensor.zui_jin_duan_xin_nei_rong', 'sender') }}
            
            ğŸ• **æ—¶é—´:** {{ state_attr('sensor.zui_jin_duan_xin_nei_rong', 'time') }}
            
            ---
            
            {{ state_attr('sensor.zui_jin_duan_xin_nei_rong', 'message') }}
        icon: mdi:message-text-outline

# ===========================================
# Lovelace å¡ç‰‡é…ç½®ç¤ºä¾‹ - å‘é€çŸ­ä¿¡ï¼ˆå¸¦äºŒæ¬¡ç¡®è®¤ï¼‰
# ===========================================
# 
# å¤åˆ¶ä»¥ä¸‹ YAML åˆ° Lovelace ä»ªè¡¨æ¿ä¸­ä½¿ç”¨
#
# --- å‘é€çŸ­ä¿¡å¡ç‰‡ ---
# type: vertical-stack
# cards:
#   - type: entities
#     title: ğŸ“¤ å‘é€çŸ­ä¿¡
#     entities:
#       - entity: input_text.sms_phone
#         name: æ‰‹æœºå·ç 
#       - entity: input_text.sms_message
#         name: çŸ­ä¿¡å†…å®¹
#       - type: divider
#       - entity: input_boolean.sms_confirm
#         name: âœ… æˆ‘ç¡®è®¤è¦å‘é€æ­¤çŸ­ä¿¡
#   - type: button
#     name: å‘é€çŸ­ä¿¡
#     icon: mdi:message-arrow-right
#     tap_action:
#       action: call-service
#       service: script.send_sms
#     icon_height: 40px
#
# --- è®¾å¤‡æ§åˆ¶å¡ç‰‡ ---
# type: vertical-stack
# cards:
#   - type: entities
#     title: âš™ï¸ è®¾å¤‡æ§åˆ¶
#     entities:
#       - entity: input_boolean.ping_confirm
#         name: âœ… ç¡®è®¤æ‰§è¡Œ Ping æµ‹è¯•
#       - entity: input_boolean.restart_confirm
#         name: âœ… ç¡®è®¤é‡å¯è®¾å¤‡ï¼ˆè°¨æ…æ“ä½œï¼‰
#   - type: horizontal-stack
#     cards:
#       - type: button
#         name: Ping æµ‹è¯•
#         icon: mdi:access-point
#         tap_action:
#           action: call-service
#           service: script.ping_sms_forwarder
#         icon_height: 40px
#       - type: button
#         name: é‡å¯è®¾å¤‡
#         icon: mdi:restart
#         tap_action:
#           action: call-service
#           service: script.restart_sms_forwarder
#         icon_height: 40px
