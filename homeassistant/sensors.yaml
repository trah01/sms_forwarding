# ===========================================
# çŸ­ä¿¡è½¬å‘å™¨ Home Assistant é…ç½®åŒ…
# ===========================================
# 
# ä½¿ç”¨æ–¹æ³•ï¼ˆæ¨èä½¿ç”¨ Packages æ–¹å¼å¼•å…¥ï¼‰ï¼š
#
# 1. å°†æ­¤æ–‡ä»¶å¤åˆ¶åˆ° Home Assistant é…ç½®ç›®å½•
#    ä¾‹å¦‚ï¼š/config/packages/sms_forwarder.yaml
#
# 2. åœ¨ configuration.yaml ä¸­æ·»åŠ ï¼š
#    homeassistant:
#      packages:
#        sms_forwarder: !include packages/sms_forwarder.yaml
#
# 3. æŠŠä¸‹é¢çš„ "123456" æ›¿æ¢æˆä½ çš„è®¾å¤‡ IDï¼ˆåœ¨çŸ­ä¿¡è½¬å‘å™¨ç½‘é¡µæŸ¥çœ‹ï¼‰
#
# 4. æŠŠ "sms" æ›¿æ¢æˆä½ è®¾ç½®çš„ä¸»é¢˜å‰ç¼€ï¼ˆå¦‚æœæœ‰ä¿®æ”¹çš„è¯ï¼‰
#
# 5. é‡å¯ Home Assistant
#
# ===========================================

mqtt:
  sensor:
    # è®¾å¤‡åœ¨çº¿çŠ¶æ€
    - name: "çŸ­ä¿¡è½¬å‘å™¨çŠ¶æ€"
      unique_id: sms_forwarder_status
      state_topic: "sms/123456/status"
      value_template: "{{ value_json.status }}"
      icon: mdi:message-text
      
    # WiFi ä¿¡å·å¼ºåº¦
    - name: "çŸ­ä¿¡è½¬å‘å™¨ WiFi ä¿¡å·"
      unique_id: sms_forwarder_wifi
      state_topic: "sms/123456/status"
      value_template: >-
        {% set rssi = value_json.wifi_rssi | int(-999) %}
        {% set status = value_json.wifi_status | default('æœªçŸ¥') %}
        {% if rssi == -999 %}æœªçŸ¥
        {% else %}{{ rssi }} dBm ({{ status }})
        {% endif %}
      icon: mdi:wifi
      
    # 4G ä¿¡å·å¼ºåº¦
    - name: "çŸ­ä¿¡è½¬å‘å™¨ 4G ä¿¡å·"
      unique_id: sms_forwarder_lte
      state_topic: "sms/123456/status"
      value_template: >-
        {% set rsrp = value_json.lte_rsrp | int(-999) %}
        {% set status = value_json.lte_status | default('æœªçŸ¥') %}
        {% if rsrp == -999 %}æœªçŸ¥
        {% else %}{{ rsrp }} dBm ({{ status }})
        {% endif %}
      icon: mdi:signal-4g
      
    # APN
    - name: "çŸ­ä¿¡è½¬å‘å™¨ APN"
      unique_id: sms_forwarder_apn
      state_topic: "sms/123456/status"
      value_template: "{{ value_json.apn | default('æœªçŸ¥') }}"
      icon: mdi:access-point-network
      
    # è®¾å¤‡ IP åœ°å€
    - name: "çŸ­ä¿¡è½¬å‘å™¨ IP"
      unique_id: sms_forwarder_ip
      state_topic: "sms/123456/status"
      value_template: "{{ value_json.ip }}"
      icon: mdi:ip-network
      
    # è¿è¡Œæ—¶é—´
    - name: "çŸ­ä¿¡è½¬å‘å™¨è¿è¡Œæ—¶é—´"
      unique_id: sms_forwarder_uptime
      state_topic: "sms/123456/status"
      value_template: "{{ (value_json.uptime | int / 3600) | round(1) }}"
      unit_of_measurement: "å°æ—¶"
      icon: mdi:clock-outline
      
    # æœ€è¿‘æ”¶åˆ°çš„çŸ­ä¿¡ - å‘é€è€…
    - name: "æœ€è¿‘çŸ­ä¿¡å‘é€è€…"
      unique_id: sms_forwarder_last_sender
      state_topic: "sms/123456/sms/received"
      value_template: "{{ value_json.sender }}"
      icon: mdi:account
      
    # æœ€è¿‘æ”¶åˆ°çš„çŸ­ä¿¡ - å†…å®¹
    # æ³¨æ„: çŠ¶æ€å€¼æœ‰ 255 å­—ç¬¦é™åˆ¶ï¼Œå®Œæ•´å†…å®¹å­˜å‚¨åœ¨ message å±æ€§ä¸­
    - name: "æœ€è¿‘çŸ­ä¿¡å†…å®¹"
      unique_id: sms_forwarder_last_message
      state_topic: "sms/123456/sms/received"
      value_template: >-
        {% set msg = value_json.message | default('') %}
        {% if msg | length > 50 %}
          {{ msg[:50] }}...
        {% else %}
          {{ msg }}
        {% endif %}
      # å®Œæ•´çŸ­ä¿¡å†…å®¹å­˜å‚¨åœ¨å±æ€§ä¸­ï¼Œæ”¯æŒæ¢è¡Œæ˜¾ç¤º
      json_attributes_topic: "sms/123456/sms/received"
      json_attributes_template: >-
        {
          "message": {{ value_json.message | default('') | tojson }},
          "sender": {{ value_json.sender | default('') | tojson }},
          "time": {{ value_json.time | default('') | tojson }}
        }
      icon: mdi:message-text
      
    # æœ€è¿‘æ¥ç”µå·ç 
    - name: "æœ€è¿‘æ¥ç”µå·ç "
      unique_id: sms_forwarder_last_caller
      state_topic: "sms/123456/call"
      value_template: "{{ value_json.caller }}"
      icon: mdi:phone-incoming

  # äºŒè¿›åˆ¶ä¼ æ„Ÿå™¨ - åœ¨çº¿çŠ¶æ€
  binary_sensor:
    - name: "çŸ­ä¿¡è½¬å‘å™¨åœ¨çº¿"
      unique_id: sms_forwarder_online
      state_topic: "sms/123456/status"
      value_template: "{{ value_json.status }}"
      payload_on: "online"
      payload_off: "offline"
      device_class: connectivity
      icon: mdi:message-check

  # æŒ‰é’® - æ§åˆ¶å‘½ä»¤
  button:
    # é‡å¯è®¾å¤‡
    - name: "çŸ­ä¿¡è½¬å‘å™¨é‡å¯"
      unique_id: sms_forwarder_restart
      command_topic: "sms/123456/cmd"
      payload_press: '{"action":"restart"}'
      icon: mdi:restart
      
    # Ping æµ‹è¯•
    - name: "çŸ­ä¿¡è½¬å‘å™¨ Ping"
      unique_id: sms_forwarder_ping
      command_topic: "sms/123456/ping"
      payload_press: '{}'
      icon: mdi:access-point

# ===========================================
# çŸ­ä¿¡å‘é€åŠŸèƒ½
# ===========================================

# è¾“å…¥è¾…åŠ©å®ä½“ - å‘é€çŸ­ä¿¡
input_text:
  sms_phone:
    name: "ç›®æ ‡æ‰‹æœºå·"
    initial: ""
    max: 20
    icon: mdi:phone
    
  sms_message:
    name: "çŸ­ä¿¡å†…å®¹"
    initial: ""
    max: 500
    icon: mdi:message-text

# è„šæœ¬ - å‘é€çŸ­ä¿¡
script:
  send_sms:
    alias: "å‘é€çŸ­ä¿¡"
    icon: mdi:message-arrow-right
    sequence:
      - service: mqtt.publish
        data:
          topic: "sms/123456/sms/send"
          payload: >-
            {"phone":"{{ states('input_text.sms_phone') }}","message":"{{ states('input_text.sms_message') }}"}
      - service: persistent_notification.create
        data:
          title: "çŸ­ä¿¡å·²å‘é€"
          message: "å‘é€åˆ°ï¼š{{ states('input_text.sms_phone') }}"
          
  restart_sms_forwarder:
    alias: "é‡å¯çŸ­ä¿¡è½¬å‘å™¨"
    icon: mdi:restart
    sequence:
      - service: mqtt.publish
        data:
          topic: "sms/123456/cmd"
          payload: '{"action":"restart"}'
      - service: persistent_notification.create
        data:
          title: "é‡å¯å‘½ä»¤å·²å‘é€"
          message: "çŸ­ä¿¡è½¬å‘å™¨å°†åœ¨å‡ ç§’åé‡å¯"
          
  ping_sms_forwarder:
    alias: "æ‰§è¡ŒPingæµ‹è¯•"
    icon: mdi:access-point
    sequence:
      - service: mqtt.publish
        data:
          topic: "sms/123456/ping"
          payload: '{}'
      - service: persistent_notification.create
        data:
          title: "Pingå‘½ä»¤å·²å‘é€"
          message: "æ­£åœ¨æ‰§è¡Œç½‘ç»œPingæµ‹è¯•"

# ===========================================
# Lovelace ä»ªè¡¨æ¿å¡ç‰‡é…ç½®ç¤ºä¾‹
# å°†ä»¥ä¸‹å†…å®¹å¤åˆ¶åˆ° Lovelace çš„"ç¼–è¾‘ä»ªè¡¨æ¿" -> "åŸå§‹é…ç½®ç¼–è¾‘å™¨"ä¸­
# ===========================================

# çŸ­ä¿¡å†…å®¹æ˜¾ç¤ºå¡ç‰‡ (æ”¯æŒæ¢è¡Œ)
# ä½¿ç”¨ Markdown å¡ç‰‡å¯ä»¥æ­£ç¡®æ˜¾ç¤ºå¤šè¡ŒçŸ­ä¿¡å†…å®¹
# 
# type: markdown
# title: ğŸ“± æœ€è¿‘çŸ­ä¿¡
# content: |
#   **å‘é€è€…:** {{ state_attr('sensor.zui_jin_duan_xin_nei_rong', 'sender') }}
#   
#   **æ—¶é—´:** {{ state_attr('sensor.zui_jin_duan_xin_nei_rong', 'time') }}
#   
#   ---
#   
#   {{ state_attr('sensor.zui_jin_duan_xin_nei_rong', 'message') }}

# å¦ä¸€ç§æ–¹å¼ï¼šä½¿ç”¨æ¨¡æ¿ä¼ æ„Ÿå™¨ (æ”¾åœ¨ configuration.yaml ä¸­)
# è¿™ç§æ–¹å¼å¯ä»¥åˆ›å»ºä¸€ä¸ªä¸“é—¨ç”¨äºæ˜¾ç¤ºçš„å®ä½“
template:
  - sensor:
      - name: "çŸ­ä¿¡è¯¦æƒ…"
        unique_id: sms_forwarder_full_message
        state: >-
          {{ states('sensor.zui_jin_duan_xin_fa_song_zhe') }}
        attributes:
          sender: >-
            {{ state_attr('sensor.zui_jin_duan_xin_nei_rong', 'sender') }}
          time: >-
            {{ state_attr('sensor.zui_jin_duan_xin_nei_rong', 'time') }}
          message: >-
            {{ state_attr('sensor.zui_jin_duan_xin_nei_rong', 'message') }}
          # æ ¼å¼åŒ–æ˜¾ç¤ºï¼Œç”¨äº Markdown å¡ç‰‡
          formatted: >-
            ğŸ“ **å‘é€è€…:** {{ state_attr('sensor.zui_jin_duan_xin_nei_rong', 'sender') }}
            
            ğŸ• **æ—¶é—´:** {{ state_attr('sensor.zui_jin_duan_xin_nei_rong', 'time') }}
            
            ---
            
            {{ state_attr('sensor.zui_jin_duan_xin_nei_rong', 'message') }}
        icon: mdi:message-text-outline

# ===========================================
# Lovelace å¡ç‰‡é…ç½®ç¤ºä¾‹ - å‘é€çŸ­ä¿¡
# ===========================================
# 
# å¤åˆ¶ä»¥ä¸‹ YAML åˆ° Lovelace ä»ªè¡¨æ¿ä¸­ä½¿ç”¨
#
# --- å‘é€çŸ­ä¿¡å¡ç‰‡ ---
# type: vertical-stack
# cards:
#   - type: entities
#     title: ğŸ“¤ å‘é€çŸ­ä¿¡
#     entities:
#       - entity: input_text.sms_phone
#         name: æ‰‹æœºå·ç 
#       - entity: input_text.sms_message
#         name: çŸ­ä¿¡å†…å®¹
#   - type: button
#     name: å‘é€çŸ­ä¿¡
#     icon: mdi:message-arrow-right
#     tap_action:
#       action: call-service
#       service: script.send_sms
#     icon_height: 40px
#
# --- è®¾å¤‡æ§åˆ¶å¡ç‰‡ ---
# type: horizontal-stack
# cards:
#   - type: button
#     name: Ping æµ‹è¯•
#     icon: mdi:access-point
#     tap_action:
#       action: call-service
#       service: script.ping_sms_forwarder
#     icon_height: 40px
#   - type: button
#     name: é‡å¯è®¾å¤‡
#     icon: mdi:restart
#     tap_action:
#       action: call-service
#       service: script.restart_sms_forwarder
#     icon_height: 40px
